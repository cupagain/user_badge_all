<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>榮耀徽章 | SWAG</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050810; --glass: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.08);
            --gold: #fbbf24; --pink: #ff2d55; --silver: linear-gradient(180deg, #FFFFFF 0%, #94a3b8 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg); color: #fff; font-family: 'Inter', sans-serif;
            background-image: radial-gradient(circle at 50% -10%, rgba(255,255,255,0.05) 0%, transparent 40%);
            min-height: 100vh; padding-bottom: 100px;
        }
        /* 頂部導覽列 */
        .top-nav { position: fixed; top: 15px; right: 15px; z-index: 100; display: flex; gap: 8px; }
        .lang-btn { background: rgba(15,23,42,0.6); border: 1px solid var(--glass-border); color: #94a3b8; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; }
        .lang-btn.active { background: #fff; color: #000; }

        /* Bento 數據區 */
        .hero { padding: 60px 20px 30px; max-width: 600px; margin: 0 auto; }
        .bento-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px; margin-bottom: 25px; }
        .bento-box { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 24px; padding: 20px; backdrop-filter: blur(20px); }
        .stat-label { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }
        .stat-val { font-family: 'Outfit', sans-serif; font-weight: 800; line-height: 1; }
        .val-silver { font-size: 48px; background: var(--silver); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .val-gold { font-size: 48px; color: var(--gold); }
        .header-text { text-align: center; }
        .main-title { font-family: 'Outfit', sans-serif; font-size: 26px; font-weight: 800; margin-bottom: 5px; }
        .sub-title { font-size: 14px; color: #94a3b8; }

        /* VIP 卡片 */
        .vip-wrap { display: flex; justify-content: center; padding: 0 20px; margin-bottom: 40px; }
        .vip-card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 28px; padding: 20px; display: flex; align-items: center; gap: 16px; max-width: 600px; width: 100%; }
        .vip-card.active-user { border-color: rgba(251,191,36,0.3); background: rgba(251,191,36,0.05); }
        .vip-img { width: 48px; height: 48px; flex-shrink: 0; }
        .status-tag { font-size: 11px; font-weight: 800; display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .vip-msg { font-size: 13px; color: #cbd5e1; font-weight: 600; }
        .request-btn { background: #1e293b; color: #475569; border: none; padding: 12px 20px; border-radius: 14px; font-size: 14px; font-weight: 800; cursor: not-allowed; transition: 0.3s; }
        .request-btn.ready { background: var(--gold); color: #000; cursor: pointer; box-shadow: 0 8px 20px rgba(251,191,36,0.3); }

        /* 徽章網格 */
        .badge-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; padding: 0 20px; max-width: 1000px; margin: 0 auto; }
        @media (min-width: 768px) { .badge-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }
        .badge-item { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 30px; padding: 30px 10px; text-align: center; transition: 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; height: 100%; position: relative; }
        .badge-item.selected { border-color: var(--gold); background: rgba(251,191,36,0.1); transform: scale(1.05); }
        .badge-item.selected::after { content: '✓'; position: absolute; top: 12px; right: 15px; color: var(--gold); font-weight: 900; }
        .badge-img { width: 80px; height: 80px; margin-bottom: 16px; filter: drop-shadow(0 8px 12px rgba(0,0,0,0.3)); }
        .badge-name { font-size: 15px; font-weight: 700; color: #f8fafc; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .skeleton { background: linear-gradient(90deg, #0f1218 25%, #1e242e 50%, #0f1218 75%); background-size: 200% 100%; animation: load 1.5s infinite linear; border-radius: 20px; }
        @keyframes load { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    <nav class="top-nav">
        <button class="lang-btn active" id="btn-zh-hant" onclick="setLang('zh-hant')">繁中</button>
        <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
        <button class="lang-btn" id="btn-ja" onclick="setLang('ja')">JP</button>
    </nav>
    <header class="hero">
        <div class="bento-grid">
            <div class="bento-box"><span class="stat-label" id="lbl-c">徽章總數</span><div class="stat-val val-silver" id="ui-count">--</div></div>
            <div class="bento-box"><span class="stat-label" id="lbl-l">用戶等級</span><div class="stat-val val-gold" id="ui-level">--</div></div>
        </div>
        <div class="header-text"><h1 class="main-title" id="ui-title">我的榮耀徽章全覽</h1><p class="sub-title" id="ui-subtitle">點擊下方徽章選取後發送需求</p></div>
    </header>
    <div class="vip-wrap">
        <div class="vip-card" id="vip-card">
            <img src="https://public.swag.live/notifications/custom/EL/vip_lv60up.png" class="vip-img">
            <div class="vip-info">
                <div class="status-tag" id="ui-status"><span style="color:#64748b">● 權限檢查中</span></div>
                <p class="vip-msg" id="ui-msg">請先選取徽章 (限 Lv.60 使用)</p>
            </div>
            <button class="request-btn" id="request-btn" onclick="sendReq()">發送</button>
        </div>
    </div>
    <main class="badge-grid" id="display"></main>

    <script>
        const CFG = {
            data: 'https://swag-badge-v2-api-905468082258.asia-east1.run.app/api/badges',
            handler: 'https://swag-request-handler-v3-905468082258.asia-east1.run.app/api/request',
            img: 'https://public.swag.live/badges/',
            trs: 'https://api.swag.live/translations'
        };
        const I18N = {
            'zh-hant': { c:"徽章總數", l:"用戶等級", title:"我的榮耀徽章全覽", sub:"點擊下方徽章選取後發送需求", lock:"權限未開啟 (需 Lv.60)", ok:"更換權限已就緒", sel:"請先選取徽章", ready:"已選取：{name}", btn:"更換需求" },
            'en': { c:"Total", l:"Level", title:"Honor Gallery", sub:"Select a badge to request change", lock:"Locked (Lv.60 Req)", ok:"Permission Ready", sel:"Select a badge first", ready:"Selected: {name}", btn:"REQUEST" }
        };

        let state = { lang:'zh-hant', level:0, selected:null, list:[] };
        const uid = new URLSearchParams(window.location.search).get('user_id');

        function setLang(l) {
            state.lang = l;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${l}`));
            if(uid) init();
        }

        async function init() {
            const box = document.getElementById('display');
            if(!uid) { box.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:#64748b">請登入查看</div>`; return; }
            box.innerHTML = Array(4).fill(0).map(()=>`<div class="badge-item"><div class="badge-img skeleton"></div><div class="skeleton" style="height:14px;width:60%"></div></div>`).join('');

            try {
                const r = await fetch(`${CFG.data}?user_id=${uid}`);
                const d = await r.json();
                state.level = d.level;
                document.getElementById('ui-count').innerText = d.count;
                document.getElementById('ui-level').innerText = d.level;

                const ids = (d.badges || []).filter(i => i.startsWith('campaign_')).sort((a,b)=>a.localeCompare(b, undefined, {numeric: true}));
                state.list = await Promise.all(ids.map(async id => {
                    const k = `badge_${id}`;
                    try {
                        const t = await fetch(`${CFG.trs}?lang=${state.lang}&key=${k}`).then(res => res.json());
                        return { id, name: t[k] || id };
                    } catch { return { id, name: id }; }
                }));
                render();
                check();
            } catch { box.innerHTML = "載入失敗"; }
        }

        function render() {
            document.getElementById('display').innerHTML = state.list.map(b => `
                <div class="badge-item ${state.selected?.id === b.id ? 'selected' : ''}" onclick="state.selected={id:'${b.id}',name:'${b.name}'};render();check();">
                    <img class="badge-img" src="${CFG.img}${b.id}.svg" onerror="this.src='${CFG.img}default.svg'">
                    <span class="badge-name">${b.name}</span>
                </div>
            `).join('');
        }

        function check() {
            const t = I18N[state.lang] || I18N['zh-hant'];
            const card = document.getElementById('vip-card');
            const btn = document.getElementById('request-btn');
            const status = document.getElementById('ui-status');
            const msg = document.getElementById('ui-msg');

            document.getElementById('lbl-c').innerText = t.c;
            document.getElementById('lbl-l').innerText = t.l;
            document.getElementById('ui-title').innerText = t.title;
            document.getElementById('ui-subtitle').innerText = t.sub;
            btn.innerText = t.btn;

            if(state.level >= 60) {
                card.classList.add('active-user');
                status.innerHTML = `<span style="color:var(--gold)">● ${t.ok}</span>`;
                if(state.selected) {
                    msg.innerText = t.ready.replace('{name}', state.selected.name);
                    btn.classList.add('ready');
                } else {
                    msg.innerText = t.sel;
                    btn.classList.remove('ready');
                }
            } else {
                status.innerHTML = `<span style="color:#64748b">● ${t.lock}</span>`;
                btn.classList.remove('ready');
            }
        }

        async function sendReq() {
            if(!document.getElementById('request-btn').classList.contains('ready')) return;
            const res = await fetch(CFG.handler, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ user_id: uid, badge_id: state.selected.id })
            });
            const d = await res.json();
            alert(res.ok ? "✅ 送出成功" : `❌ 失敗: ${d.error}`);
        }

        setLang('zh-hant');
    </script>
</body>
</html>
