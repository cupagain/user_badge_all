<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>我的榮耀徽章 | SWAG Premium</title>
    
    <!-- Premium Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #050810;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-pink: #ff2d55;
            --accent-gold: #fbbf24;
            --silver-grad: linear-gradient(180deg, #FFFFFF 0%, #94a3b8 100%);
            --text-main: #ffffff;
            --text-dim: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 50% -10%, rgba(255, 255, 255, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 0% 100%, rgba(255, 45, 85, 0.05) 0%, transparent 40%);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            min-height: 100vh; padding-bottom: 120px; overflow-x: hidden;
        }

        /* 導覽列 */
        .top-nav { position: fixed; top: 15px; right: 15px; z-index: 100; display: flex; gap: 8px; }
        .lang-btn { 
            background: rgba(15, 23, 42, 0.6); border: 1px solid var(--glass-border); 
            color: var(--text-dim); padding: 6px 12px; border-radius: 8px; 
            font-size: 11px; font-weight: 700; backdrop-filter: blur(10px); cursor: pointer;
        }
        .lang-btn.active { background: #fff; color: #000; border-color: #fff; }

        /* Bento 數據區 */
        .hero { padding: calc(60px + env(safe-area-inset-top)) 20px 30px; max-width: 600px; margin: 0 auto; }
        .bento-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px; margin-bottom: 25px; }
        .bento-box {
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 20px; backdrop-filter: blur(20px);
        }
        .stat-label { font-size: 12px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block;}
        .stat-val { font-family: 'Outfit', sans-serif; line-height: 1; font-weight: 800; }
        .val-silver { font-size: 48px; background: var(--silver-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .val-gold { font-size: 48px; color: var(--accent-gold); }

        .header-text { text-align: center; margin-top: 10px; }
        .main-title { font-family: 'Outfit', sans-serif; font-size: 26px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 5px; }
        .sub-title { font-size: 14px; color: var(--text-dim); line-height: 1.4; }

        /* VIP 功能卡片 */
        .vip-wrap { display: flex; justify-content: center; width: 100%; padding: 0 20px; margin-bottom: 40px; }
        .vip-card {
            background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); border-radius: 28px;
            padding: 20px; display: flex; align-items: center; gap: 16px;
            max-width: 600px; width: 100%; transition: 0.4s;
        }
        .vip-card.active-user { border-color: rgba(251, 191, 36, 0.3); background: rgba(251, 191, 36, 0.05); }
        .vip-card.locked { opacity: 0.5; filter: grayscale(0.8); }

        .vip-img { width: 50px; height: 50px; flex-shrink: 0; }
        .status-tag { font-size: 11px; font-weight: 800; letter-spacing: 1px; margin-bottom: 4px; display: flex; align-items: center; gap: 5px; }
        .tag-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
        .vip-msg { font-size: 13px; color: #cbd5e1; font-weight: 600; line-height: 1.4; }

        /* 按鈕樣式 */
        .request-btn {
            background: #1e293b; color: #475569; border: none; padding: 12px 20px; border-radius: 14px;
            font-size: 14px; font-weight: 800; cursor: not-allowed; transition: 0.3s; white-space: nowrap;
        }
        .request-btn.ready { background: var(--accent-gold); color: #000; cursor: pointer; box-shadow: 0 8px 20px rgba(251, 191, 36, 0.3); }
        .request-btn.submitting { opacity: 0.7; cursor: wait; }

        /* 徽章網格 - 絕對 50/50 對稱 */
        .badge-grid {
            display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px;
            padding: 0 20px; max-width: 1000px; margin: 0 auto;
        }
        @media (min-width: 768px) { .badge-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 24px; } }

        .badge-item {
            background: var(--glass); border: 1px solid var(--glass-border); border-radius: 30px;
            padding: 30px 10px; text-align: center; backdrop-filter: blur(15px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            display: flex; flex-direction: column; align-items: center; height: 100%; cursor: pointer;
            position: relative;
        }
        .badge-item:hover { border-color: rgba(255, 255, 255, 0.3); }
        .badge-item.selected { border-color: var(--accent-gold); background: rgba(251, 191, 36, 0.1); transform: scale(1.05); box-shadow: 0 0 30px rgba(251, 191, 36, 0.2); }
        .badge-item.selected::after { content: '✓'; position: absolute; top: 12px; right: 15px; color: var(--accent-gold); font-weight: 900; font-size: 18px; }

        .badge-img { width: 80px; height: 80px; margin-bottom: 20px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4)); transition: 0.3s; }
        .badge-item.selected .badge-img { filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.5)); }

        .badge-name { font-size: 16px; font-weight: 700; color: #f8fafc; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; word-break: break-all; }

        /* 骨架屏 */
        .skeleton { background: linear-gradient(90deg, #0f1218 25%, #1e242e 50%, #0f1218 75%); background-size: 200% 100%; animation: load 1.5s infinite linear; border-radius: 20px; }
        @keyframes load { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* 底部提示 */
        .bottom-hint {
            position: fixed; bottom: 0; left: 0; right: 0; padding: 15px;
            background: rgba(5, 8, 16, 0.95); backdrop-filter: blur(10px);
            text-align: center; font-size: 12px; color: var(--accent-gold);
            font-weight: 700; border-top: 1px solid var(--glass-border);
            transform: translateY(100%); transition: 0.3s; z-index: 1000;
        }
        .bottom-hint.show { transform: translateY(0); }
    </style>
</head>
<body>

    <nav class="top-nav">
        <button class="lang-btn active" id="btn-zh-hant" onclick="setLang('zh-hant')">繁中</button>
        <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
        <button class="lang-btn" id="btn-ja" onclick="setLang('ja')">JP</button>
    </nav>

    <header class="hero">
        <div class="bento-grid">
            <div class="bento-box">
                <span class="stat-label" id="lbl-count">Total Badges</span>
                <div class="stat-val val-silver" id="ui-count">--</div>
            </div>
            <div class="bento-box">
                <span class="stat-label" id="lbl-level">User Level</span>
                <div class="stat-val val-gold" id="ui-level">--</div>
            </div>
        </div>
        <div class="header-text">
            <h1 class="main-title" id="ui-title">我的榮耀徽章全覽</h1>
            <p class="sub-title" id="ui-subtitle">點擊下方徽章即可選取並申請更換</p>
        </div>
    </header>

    <div class="vip-wrap">
        <div class="vip-card locked" id="vip-card">
            <img src="https://public.swag.live/notifications/custom/EL/vip_lv60up.png" class="vip-img" alt="VIP">
            <div class="vip-info">
                <div class="status-tag" id="ui-status">
                    <span class="tag-dot" style="background: #64748b;"></span>
                    <span style="color: #64748b;">權限未開啟</span>
                </div>
                <p class="vip-msg" id="ui-vip-msg">請先選取一個徽章 (限 Lv.60 使用)</p>
            </div>
            <button class="request-btn" id="request-btn" onclick="sendRequest()">更換需求</button>
        </div>
    </div>

    <main class="badge-grid" id="badge-display"></main>
    <div class="bottom-hint" id="selection-hint">請選取徽章以發送需求</div>

    <script>
        const CFG = {
            dataApi: 'https://swag-badge-v2-api-905468082258.asia-east1.run.app/api/badges',
            handlerApi: 'https://swag-request-handler-905468082258.asia-east1.run.app/api/request',
            img: 'https://public.swag.live/badges/',
            trs: 'https://api.swag.live/translations'
        };

        const I18N = {
            'zh-hant': { lbl_c: "徽章總數", lbl_l: "用戶等級", title: "我的榮耀徽章全覽", subtitle: "點擊徽章即可進行選取並申請更換", lock: "權限未開啟 (限 Lv.60)", unlock: "權限已就緒", select_first: "請先選取一個徽章", ready_to_go: "已選取：{name}", btn: "更換需求", sending: "傳送中...", success: "✅ 更換需求已成功送出！", cooldown: "⏳ 24 小時內僅能申請一次，請稍後再試。", err: "❌ 申請失敗：" },
            'en': { lbl_c: "Total", lbl_l: "Level", title: "Honor Badge Gallery", subtitle: "Select a badge to request change", lock: "Locked (Lv.60 Required)", unlock: "Permission Ready", select_first: "Please select a badge", ready_to_go: "Selected: {name}", btn: "REQUEST", sending: "Sending...", success: "✅ Request sent successfully!", cooldown: "⏳ 24h cooldown in effect.", err: "❌ Failed: " },
            'ja': { lbl_c: "バッジ總數", lbl_l: "レベル", title: "栄光のバッジ一覧", subtitle: "バッジを選択して交換を申請します", lock: "権限未開放 (Lv.60が必要)", unlock: "準備完了", select_first: "バッジを選択してください", ready_to_go: "選択中：{name}", btn: "リクエスト", success: "リクエストが送信されました！" }
        };

        let state = { lang: 'zh-hant', userLevel: 0, selectedBadge: null, badgeList: [], isSubmitting: false };
        const uid = new URLSearchParams(window.location.search).get('user_id');

        function setLang(l) {
            state.lang = l;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${l}`));
            updateUIStrings();
            if(uid) init();
        }

        function updateUIStrings() {
            const t = I18N[state.lang];
            document.getElementById('lbl-count').textContent = t.lbl_c;
            document.getElementById('lbl-level').textContent = t.lbl_l;
            document.getElementById('ui-title').textContent = t.title;
            document.getElementById('ui-subtitle').textContent = t.subtitle;
            document.getElementById('request-btn').textContent = t.btn;
            checkButtonStatus();
        }

        async function init() {
            const box = document.getElementById('badge-display');
            if (!uid) { box.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: #64748b; padding: 40px;">Please Login to see badges.</div>`; return; }
            box.innerHTML = Array(4).fill(0).map(() => `<div class="badge-item"><div class="badge-img skeleton"></div><div class="skeleton" style="height:16px; width:60%;"></div></div>`).join('');

            try {
                const r = await fetch(`${CFG.dataApi}?user_id=${uid}`);
                const d = await r.json();
                state.userLevel = d.level;
                document.getElementById('ui-count').textContent = d.count;
                document.getElementById('ui-level').textContent = d.level;

                const ids = (d.badges || []).filter(i => i.startsWith('campaign_')).sort((a,b) => {
                    const rx = /^(.*?)([0-9]*)$/;
                    const ma = a.match(rx), mb = b.match(rx);
                    if (ma[1] === mb[1]) return (parseInt(ma[2]) || 0) - (parseInt(mb[2]) || 0);
                    return a.localeCompare(b);
                });

                state.badgeList = await Promise.all(ids.map(async (id) => {
                    const k = `badge_${id}`;
                    try {
                        const tr = await fetch(`${CFG.trs}?lang=${state.lang}&key=${k}`);
                        const tj = await tr.json();
                        return { id, name: tj[k] || id };
                    } catch { return { id, name: id }; }
                }));

                renderGrid();
                checkButtonStatus();
            } catch { box.innerHTML = `<div style="grid-column:1/-1; text-align:center;">Load Error.</div>`; }
        }

        function renderGrid() {
            const box = document.getElementById('badge-display');
            box.innerHTML = state.badgeList.map(b => `
                <div class="badge-item ${state.selectedBadge?.id === b.id ? 'selected' : ''}" onclick="selectBadge('${b.id}')">
                    <img class="badge-img" src="${CFG.img}${b.id}.svg" onerror="this.src='${CFG.img}default.svg'">
                    <span class="badge-name">${b.name}</span>
                </div>
            `).join('');
        }

        function selectBadge(id) {
            if (state.isSubmitting) return;
            state.selectedBadge = state.badgeList.find(b => b.id === id);
            renderGrid();
            checkButtonStatus();
            if (window.navigator.vibrate) window.navigator.vibrate(10);
        }

        function checkButtonStatus() {
            const vipCard = document.getElementById('vip-card');
            const reqBtn = document.getElementById('request-btn');
            const statusLabel = document.getElementById('ui-status');
            const msgLabel = document.getElementById('ui-vip-msg');
            const hint = document.getElementById('selection-hint');
            const t = I18N[state.lang];

            if (state.userLevel >= 60) {
                vipCard.classList.remove('locked');
                vipCard.classList.add('active-user');
                statusLabel.innerHTML = `<span class="tag-dot" style="background: var(--accent-gold);"></span><span style="color: var(--accent-gold);">${t.unlock}</span>`;
                if (state.selectedBadge) {
                    msgLabel.textContent = t.ready_to_go.replace('{name}', state.selectedBadge.name);
                    reqBtn.classList.add('ready');
                    reqBtn.disabled = false;
                    hint.classList.remove('show');
                } else {
                    msgLabel.textContent = t.select_first;
                    reqBtn.classList.remove('ready');
                    reqBtn.disabled = true;
                    hint.classList.add('show');
                }
            } else {
                vipCard.classList.add('locked');
                statusLabel.innerHTML = `<span class="tag-dot" style="background: #64748b;"></span><span style="color: #64748b;">${t.lock}</span>`;
                reqBtn.classList.remove('ready');
                reqBtn.disabled = true;
                hint.classList.remove('show');
            }
        }

        async function sendRequest() {
            const btn = document.getElementById('request-btn');
            const t = I18N[state.lang];
            if (!btn.classList.contains('ready') || state.isSubmitting) return;

            state.isSubmitting = true;
            btn.textContent = t.sending;
            btn.classList.add('submitting');

            try {
                const response = await fetch(CFG.handlerApi, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: uid, badge_id: state.selectedBadge.id })
                });

                const result = await response.json();
                if (response.ok) {
                    alert(t.success);
                } else if (response.status === 429) {
                    alert(t.cooldown);
                } else {
                    alert(t.err + (result.error || "Unknown Error"));
                }
            } catch (err) {
                alert("❌ Network Error: 伺服器連線失敗。");
            } finally {
                state.isSubmitting = false;
                btn.classList.remove('submitting');
                btn.textContent = t.btn;
                checkButtonStatus();
            }
        }
        setLang('zh-hant');
    </script>
</body>
</html>
